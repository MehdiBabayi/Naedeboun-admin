# Ú©Ø¯Ù‡Ø§ÛŒ Ú©Ø§Ù…Ù„ ØªØºÛŒÛŒØ±Ø§Øª - Ø§Ø¯ØºØ§Ù… lessons Ø¨Ø§ lesson_videos

Ø§ÛŒÙ† ÙØ§ÛŒÙ„ Ø´Ø§Ù…Ù„ ØªÙ…Ø§Ù… Ú©Ø¯Ù‡Ø§ÛŒ Ú©Ø§Ù…Ù„ ØªØºÛŒÛŒØ± ÛŒØ§ÙØªÙ‡ Ø§Ø³Øª Ú©Ù‡ Ø¯Ø± Ù¾Ù„Ù† Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.

---

## âš ï¸ Ù‚ÙˆØ§Ù†ÛŒÙ† Ø§Ø¬Ø±Ø§ÛŒ Ù¾Ù„Ù† (CRITICAL - Ø­ØªÙ…Ø§Ù‹ Ø±Ø¹Ø§ÛŒØª Ø´ÙˆØ¯)

### 1. ØªÙˆÙ‚Ù Ø¨ÛŒÙ† Ù…Ø±Ø§Ø­Ù„ (Ù…Ù‡Ù…)
- **Ù‡Ø± Ù…Ø±Ø­Ù„Ù‡ Ø¨Ø§ÛŒØ¯ Ø§Ø² Ú©Ø§Ø±Ø¨Ø± Ø§Ø¬Ø§Ø²Ù‡ Ø¨Ú¯ÛŒØ±Ø¯ Ù‚Ø¨Ù„ Ø§Ø² Ø±ÙØªÙ† Ø¨Ù‡ Ù…Ø±Ø­Ù„Ù‡ Ø¨Ø¹Ø¯**
- Ø¨Ø¹Ø¯ Ø§Ø² Ø§Ù†Ø¬Ø§Ù… Ù‡Ø± Ù…Ø±Ø­Ù„Ù‡ØŒ ØªÙˆÙ‚Ù Ú©Ù† Ùˆ Ù…Ù†ØªØ¸Ø± ØªØ£ÛŒÛŒØ¯ Ú©Ø§Ø±Ø¨Ø± Ø¨Ù…Ø§Ù†
- Ù‡Ø±Ú¯Ø² Ø¨Ø¯ÙˆÙ† Ø§Ø¬Ø§Ø²Ù‡ Ø¨Ù‡ Ù…Ø±Ø­Ù„Ù‡ Ø¨Ø¹Ø¯ Ù†Ø±Ùˆ

### 2. ØªÙˆØ¶ÛŒØ­ Ø¯Ø± Ù‡Ø± Ù…Ø±Ø­Ù„Ù‡
- Ø¯Ø± Ù‡Ø± Ù…Ø±Ø­Ù„Ù‡ ØªÙˆØ¶ÛŒØ­ Ø¨Ø¯Ù‡ Ú©Ù‡ Ú†Ù‡ Ú©Ø§Ø±ÛŒ Ø§Ù†Ø¬Ø§Ù… Ø¯Ø§Ø¯ÛŒ
- Ú†Ù‡ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒÛŒ ØªØºÛŒÛŒØ± Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ
- Ú†Ù‡ ØªØºÛŒÛŒØ±Ø§ØªÛŒ Ø§Ø¹Ù…Ø§Ù„ Ø´Ø¯Ù‡

### 3. Deploy Ú©Ø±Ø¯Ù† Function
- **Ø§Ú¯Ø± function Ù…ÛŒâ€ŒÙ†ÙˆÛŒØ³ÛŒ/ØªØºÛŒÛŒØ± Ù…ÛŒâ€ŒØ¯ÛŒ â†’ Ø¨Ø§ÛŒØ¯ deploy Ú©Ù†ÛŒ**
- Ù‚Ø¨Ù„ Ø§Ø² Ø±ÙØªÙ† Ø¨Ù‡ Ù…Ø±Ø­Ù„Ù‡ Ø¨Ø¹Ø¯ØŒ function Ø±Ø§ deploy Ú©Ù†
- Ø§Ú¯Ø± deploy Ù…ÙˆÙÙ‚ Ù†Ø¨ÙˆØ¯ â†’ **Ù…ØªÙˆÙ‚Ù Ø´Ùˆ Ùˆ Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø± Ø§Ø¹Ù„Ø§Ù… Ú©Ù†**

### 4. Deploy Ú©Ø±Ø¯Ù† Query/Migration
- **Ø§Ú¯Ø± query/migration Ù…ÛŒâ€ŒÙ†ÙˆÛŒØ³ÛŒ â†’ Ø¨Ø§ÛŒØ¯ deploy Ú©Ù†ÛŒ**
- Ù‚Ø¨Ù„ Ø§Ø² Ø±ÙØªÙ† Ø¨Ù‡ Ù…Ø±Ø­Ù„Ù‡ Ø¨Ø¹Ø¯ØŒ migration Ø±Ø§ deploy Ú©Ù†
- Ø§Ú¯Ø± deploy Ù…ÙˆÙÙ‚ Ù†Ø¨ÙˆØ¯ â†’ **Ù…ØªÙˆÙ‚Ù Ø´Ùˆ Ùˆ Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø± Ø§Ø¹Ù„Ø§Ù… Ú©Ù†**

### 5. Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² ANPIX Ù‚Ø¨Ù„ Ø§Ø² CLIA
- **Ù‡Ù…ÛŒØ´Ù‡ Ø§Ø² ANPIX (Ø¢Ù†Ø§Ù„ÛŒØ² Ù¾Ø±ÙˆÚ˜Ù‡) Ù‚Ø¨Ù„ Ø§Ø² CLIA Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†**
- Ø§Ø¨ØªØ¯Ø§ Ù¾Ø±ÙˆÚ˜Ù‡ Ø±Ø§ Ø¢Ù†Ø§Ù„ÛŒØ² Ú©Ù†ØŒ Ø³Ù¾Ø³ ØªØºÛŒÛŒØ±Ø§Øª Ø±Ø§ Ø§Ø¹Ù…Ø§Ù„ Ú©Ù†

### 6. Flutter Analyze Ø¯Ø± Ù¾Ø§ÛŒØ§Ù†
- **Ø¨Ø¹Ø¯ Ø§Ø² ØªÙ…Ø§Ù… ØªØºÛŒÛŒØ±Ø§Øª Flutter â†’ Ø¨Ø§ÛŒØ¯ `flutter analyze` Ø¨Ø²Ù†ÛŒ**
- Ù‚Ø¨Ù„ Ø§Ø² Ø§ØªÙ…Ø§Ù… Ú©Ø§Ø±ØŒ Ø­ØªÙ…Ø§Ù‹ analyze Ø±Ø§ Ø§Ø¬Ø±Ø§ Ú©Ù†
- Ø§Ú¯Ø± Ø®Ø·Ø§ Ø¯Ø§Ø´Øª â†’ **Ù…ØªÙˆÙ‚Ù Ø´Ùˆ Ùˆ Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø± Ø§Ø¹Ù„Ø§Ù… Ú©Ù†**

### 7. ØªÙˆÙ‚Ù Ø¯Ø± ØµÙˆØ±Øª Ø®Ø·Ø§
- **Ø§Ú¯Ø± Ù…ÙˆÙÙ‚ Ø¨Ù‡ deploy query ÛŒØ§ function Ù†Ø´Ø¯ÛŒ â†’ Ù…ØªÙˆÙ‚Ù Ø´Ùˆ**
- **Ø§Ú¯Ø± flutter analyze Ø®Ø·Ø§ Ø¯Ø§Ø´Øª â†’ Ù…ØªÙˆÙ‚Ù Ø´Ùˆ**
- Ø¯Ø± Ù‡Ø± Ø¯Ùˆ Ø­Ø§Ù„ØªØŒ Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø± Ø§Ø¹Ù„Ø§Ù… Ú©Ù† ØªØ§ Ø§Ø² Ø±ÙˆØ´â€ŒÙ‡Ø§ÛŒ Ø¯ÛŒÚ¯Ø± Ø§Ù‚Ø¯Ø§Ù… Ú©Ù†Ø¯

### Ø®Ù„Ø§ØµÙ‡ Ù‚ÙˆØ§Ù†ÛŒÙ†:
1. â¸ï¸ ØªÙˆÙ‚Ù Ø¨ÛŒÙ† Ù…Ø±Ø§Ø­Ù„ + Ú¯Ø±ÙØªÙ† Ø§Ø¬Ø§Ø²Ù‡
2. ğŸ“ ØªÙˆØ¶ÛŒØ­ Ù‡Ø± Ù…Ø±Ø­Ù„Ù‡
3. ğŸš€ Deploy Function Ø¨Ø¹Ø¯ Ø§Ø² Ù†ÙˆØ´ØªÙ†
4. ğŸ—„ï¸ Deploy Query Ø¨Ø¹Ø¯ Ø§Ø² Ù†ÙˆØ´ØªÙ†
5. ğŸ” Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² ANPIX Ù‚Ø¨Ù„ Ø§Ø² CLIA
6. âœ… Flutter Analyze Ø¯Ø± Ù¾Ø§ÛŒØ§Ù†
7. â›” ØªÙˆÙ‚Ù Ø¯Ø± ØµÙˆØ±Øª Ø®Ø·Ø§

---

## 1. Migration SQL (Ú©Ø§Ù…Ù„)

ÙØ§ÛŒÙ„: `supabase/migrations/YYYYMMDDHHMMSS_merge_lessons_into_lesson_videos.sql`

```sql
-- ============================================
-- Ø§Ø¯ØºØ§Ù… Ø¬Ø¯ÙˆÙ„ lessons Ø¨Ø§ lesson_videos
-- ============================================

-- Ú¯Ø§Ù… 1: Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø³ØªÙˆÙ†â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯
ALTER TABLE lesson_videos 
ADD COLUMN IF NOT EXISTS lesson_title TEXT,
ADD COLUMN IF NOT EXISTS lesson_order INT,
ADD COLUMN IF NOT EXISTS chapter_id INT,
ADD COLUMN IF NOT EXISTS chapter_order INT,
ADD COLUMN IF NOT EXISTS chapter_title TEXT;

-- Ú¯Ø§Ù… 2: Ù¾Ø± Ú©Ø±Ø¯Ù† Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ¬ÙˆØ¯
UPDATE lesson_videos lv
SET 
  lesson_title = l.title,
  lesson_order = l.lesson_order,
  chapter_id = l.chapter_id,
  chapter_order = ch.chapter_order,
  chapter_title = ch.title
FROM lessons l
JOIN chapters ch ON ch.id = l.chapter_id
WHERE lv.lesson_id = l.id;

-- Ú¯Ø§Ù… 2.5: Ø¨Ø±Ø±Ø³ÛŒ Ùˆ Ø­Ø°Ù Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§ÛŒ Ø¨Ø¯ÙˆÙ† lesson_id (Ø¨Ø±Ø§ÛŒ Ø§Ø·Ù…ÛŒÙ†Ø§Ù†)
-- Ø§Ú¯Ø± Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§ÛŒÛŒ Ø¨Ø¯ÙˆÙ† lesson_id ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ù†Ø¯ØŒ Ø¢Ù†â€ŒÙ‡Ø§ Ø±Ø§ Ø­Ø°Ù Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
DELETE FROM lesson_videos
WHERE lesson_id IS NULL 
   OR lesson_id NOT IN (SELECT id FROM lessons);

-- Ú¯Ø§Ù… 3: ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ NOT NULL
ALTER TABLE lesson_videos
ALTER COLUMN lesson_title SET NOT NULL,
ALTER COLUMN lesson_order SET NOT NULL,
ALTER COLUMN chapter_id SET NOT NULL,
ALTER COLUMN chapter_order SET NOT NULL,
ALTER COLUMN chapter_title SET NOT NULL;

-- Ú¯Ø§Ù… 4: Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Foreign Key
ALTER TABLE lesson_videos
ADD CONSTRAINT fk_lesson_videos_chapter 
FOREIGN KEY (chapter_id) REFERENCES chapters(id) ON DELETE CASCADE;

-- Ú¯Ø§Ù… 4.5: Ø­Ø°Ù Foreign Key Ù‚Ø¯ÛŒÙ…ÛŒ prereq_lesson_id (Ø§Ú¯Ø± ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯)
ALTER TABLE lesson_videos
DROP CONSTRAINT IF EXISTS lesson_videos_prereq_lesson_id_fkey;

-- Ú¯Ø§Ù… 5: Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Unique Constraint (Ø§Ø¨ØªØ¯Ø§ constraint Ù‚Ø¯ÛŒÙ…ÛŒ Ø±Ø§ Ø­Ø°Ù Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…)
ALTER TABLE lesson_videos
DROP CONSTRAINT IF EXISTS unique_lesson_video;

ALTER TABLE lesson_videos
ADD CONSTRAINT unique_lesson_video UNIQUE (
  chapter_id,
  lesson_order,
  lesson_title,
  teacher_id,
  style
);

-- Ú¯Ø§Ù… 6: Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Indexes
CREATE INDEX IF NOT EXISTS idx_lesson_videos_chapter 
ON lesson_videos(chapter_id, lesson_order);

CREATE INDEX IF NOT EXISTS idx_lesson_videos_style 
ON lesson_videos(style) WHERE active = true;

CREATE INDEX IF NOT EXISTS idx_lesson_videos_active 
ON lesson_videos(active) WHERE active = true;

-- Ú¯Ø§Ù… 7: Ø­Ø°Ù Foreign Key Ù‚Ø¯ÛŒÙ…ÛŒ
ALTER TABLE lesson_videos
DROP CONSTRAINT IF EXISTS lesson_videos_lesson_id_fkey;

-- Ú¯Ø§Ù… 8: Ø­Ø°Ù Ø³ØªÙˆÙ† lesson_id
ALTER TABLE lesson_videos
DROP COLUMN IF EXISTS lesson_id;

-- Ú¯Ø§Ù… 9: (Ø¨Ø¹Ø¯ Ø§Ø² ØªØ³Øª) Ø­Ø°Ù Ø¬Ø¯ÙˆÙ„ lessons
-- DROP TABLE IF EXISTS lessons CASCADE;
```

---

## 2. Edge Function: create-content/index.ts (Ú©Ø§Ù…Ù„)

### ØªØºÛŒÛŒØ±Ø§Øª Ø§ØµÙ„ÛŒ:
- Ø­Ø°Ù Ù…Ø±Ø­Ù„Ù‡ 7 (Ø®Ø·ÙˆØ· 213-235)
- ØªØºÛŒÛŒØ± Ù…Ø±Ø­Ù„Ù‡ 9 Ø¨Ù‡ upsert Ø¨Ø§ ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯

```typescript
import { serve } from "https://deno.land/std@0.177.0/http/server.ts";
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
};

interface ContentInput {
  branch: string;
  grade: string;
  track?: string | null;
  subject: string;
  subject_slug: string;
  chapter_order: number;
  chapter_title: string;
  lesson_order: number;
  lesson_title: string;
  teacher_name: string;
  style: 'note' | 'book' | 'sample' | 'Ø¬Ø²ÙˆÙ‡' | 'Ú©ØªØ§Ø¨ Ø¯Ø±Ø³ÛŒ' | 'Ù†Ù…ÙˆÙ†Ù‡ Ø³ÙˆØ§Ù„';
  aparat_url?: string;
  duration_sec: number;
  tags?: string[];
  prereq_lesson_id?: number | null;
  active?: boolean;
  content_status?: 'draft' | 'published' | 'archived';
  embed_html?: string;
  allow_landscape?: boolean;
  note_pdf_url?: string | null;
  exercise_pdf_url?: string | null;
}

serve(async (req) => {
  if (req.method === 'OPTIONS') {
    return new Response('ok', { headers: corsHeaders });
  }

  try {
    const input: ContentInput = await req.json();
    
    if (!input.branch || !input.grade || !input.subject || !input.subject_slug || 
        !input.chapter_title || !input.lesson_title || !input.teacher_name) {
      return new Response(
        JSON.stringify({ error: "ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø§Ù„Ø²Ø§Ù…ÛŒ: branch, grade, subject, subject_slug, chapter_title, lesson_title, teacher_name" }),
        { status: 400, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
      );
    }

    const supabaseUrl = Deno.env.get('SUPABASE_URL') ?? '';
    const serviceRoleKey = Deno.env.get('SUPABASE_SERVICE_ROLE_KEY') ?? '';
    
    if (!supabaseUrl || !serviceRoleKey) {
      return new Response(
        JSON.stringify({ error: 'ENV Ù†Ø§Ù‚Øµ Ø§Ø³Øª: SUPABASE_URL ÛŒØ§ SUPABASE_SERVICE_ROLE_KEY ØªÙ†Ø¸ÛŒÙ… Ù†Ø´Ø¯Ù‡' }),
        { status: 500, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
      );
    }

    const supabase = createClient(supabaseUrl, serviceRoleKey);

    // 1. Find or create branch
    let { data: branch, error: branchError } = await supabase
      .from('branches')
      .select('id')
      .eq('name', input.branch)
      .single();

    if (branchError && branchError.code === 'PGRST116') {
      const { data: newBranch, error: createBranchError } = await supabase
        .from('branches')
        .insert({ name: input.branch })
        .select('id')
        .single();
      if (createBranchError) throw new Error(`Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø§Ø®Ù‡: ${createBranchError.message}`);
      branch = newBranch;
    } else if (branchError) {
      throw new Error(`Ø®Ø·Ø§ Ø¯Ø± ÛŒØ§ÙØªÙ† Ø´Ø§Ø®Ù‡: ${branchError.message}`);
    }

    // 2. Find or create grade
    let { data: grade, error: gradeError } = await supabase
      .from('grades')
      .select('id')
      .eq('branch_id', branch.id)
      .eq('name', input.grade)
      .single();

    if (gradeError && gradeError.code === 'PGRST116') {
      const { data: newGrade, error: createGradeError } = await supabase
        .from('grades')
        .insert({ 
          branch_id: branch.id, 
          name: input.grade 
        })
        .select('id')
        .single();
      if (createGradeError) throw new Error(`Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ Ù¾Ø§ÛŒÙ‡: ${createGradeError.message}`);
      grade = newGrade;
    } else if (gradeError) {
      throw new Error(`Ø®Ø·Ø§ Ø¯Ø± ÛŒØ§ÙØªÙ† Ù¾Ø§ÛŒÙ‡: ${gradeError.message}`);
    }

    // 3. Find or create track (if provided)
    let track = null;
    if (input.track) {
      let { data: trackData, error: trackError } = await supabase
        .from('tracks')
        .select('id')
        .eq('name', input.track)
        .single();

      if (trackError && trackError.code === 'PGRST116') {
        const { data: newTrack, error: createTrackError } = await supabase
          .from('tracks')
          .insert({ name: input.track })
          .select('id')
          .single();
        if (createTrackError) throw new Error(`Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ Ø±Ø´ØªÙ‡: ${createTrackError.message}`);
        track = newTrack;
      } else if (trackError) {
        throw new Error(`Ø®Ø·Ø§ Ø¯Ø± ÛŒØ§ÙØªÙ† Ø±Ø´ØªÙ‡: ${trackError.message}`);
      } else {
        track = trackData;
      }
    }

    // 4. Find or create subject
    let { data: subject, error: subjectError } = await supabase
      .from('subjects')
      .select('id')
      .eq('slug', input.subject_slug)
      .single();

    if (subjectError && subjectError.code === 'PGRST116') {
      const iconPath = `assets/images/icon-darsha/${input.subject_slug}.png`;
      const bookCoverPath = `assets/images/book-covers/${input.subject_slug}${input.grade}.jpg`;
      
      const { data: newSubject, error: createSubjectError } = await supabase
        .from('subjects')
        .insert({ 
          name: input.subject,
          slug: input.subject_slug,
          icon_path: iconPath,
          book_cover_path: bookCoverPath
        })
        .select('id')
        .single();
      if (createSubjectError) throw new Error(`Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ Ø¯Ø±Ø³: ${createSubjectError.message}`);
      subject = newSubject;
    } else if (subjectError) {
      throw new Error(`Ø®Ø·Ø§ Ø¯Ø± ÛŒØ§ÙØªÙ† Ø¯Ø±Ø³: ${subjectError.message}`);
    }

    // 5. Find or create subject_offer
    let subjectOfferQuery = supabase
      .from('subject_offers')
      .select('id')
      .eq('subject_id', subject.id)
      .eq('grade_id', grade.id);

    if (track?.id) {
      subjectOfferQuery = subjectOfferQuery.eq('track_id', track.id);
    } else {
      subjectOfferQuery = subjectOfferQuery.is('track_id', null);
    }

    let { data: subjectOffer, error: subjectOfferError } = await subjectOfferQuery.single();

    if (subjectOfferError && subjectOfferError.code === 'PGRST116') {
      const { data: newSubjectOffer, error: createSubjectOfferError } = await supabase
        .from('subject_offers')
        .insert({ 
          subject_id: subject.id,
          grade_id: grade.id,
          track_id: track?.id || null
        })
        .select('id')
        .single();
      if (createSubjectOfferError) throw new Error(`Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ Ø§Ø±Ø§Ø¦Ù‡ Ø¯Ø±Ø³: ${createSubjectOfferError.message}`);
      subjectOffer = newSubjectOffer;
    } else if (subjectOfferError) {
      throw new Error(`Ø®Ø·Ø§ Ø¯Ø± ÛŒØ§ÙØªÙ† Ø§Ø±Ø§Ø¦Ù‡ Ø¯Ø±Ø³: ${subjectOfferError.message}`);
    }

    // 6. Find or create chapter
    let { data: chapter, error: chapterError } = await supabase
      .from('chapters')
      .select('id')
      .eq('subject_offer_id', subjectOffer.id)
      .eq('chapter_order', input.chapter_order)
      .single();

    if (chapterError && chapterError.code === 'PGRST116') {
      const chapterImagePath = `assets/images/chapter-images/${input.subject_slug}${input.grade}_ch${input.chapter_order}.jpg`;
      
      const { data: newChapter, error: createChapterError } = await supabase
        .from('chapters')
        .insert({ 
          subject_offer_id: subjectOffer.id,
          chapter_order: input.chapter_order,
          title: input.chapter_title,
          chapter_image_path: chapterImagePath
        })
        .select('id')
        .single();
      if (createChapterError) throw new Error(`Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ ÙØµÙ„: ${createChapterError.message}`);
      chapter = newChapter;
    } else if (chapterError) {
      throw new Error(`Ø®Ø·Ø§ Ø¯Ø± ÛŒØ§ÙØªÙ† ÙØµÙ„: ${chapterError.message}`);
    }

    // 7. Find or create teacher (Ù…Ø±Ø­Ù„Ù‡ 8 Ø¯Ø± Ú©Ø¯ Ù‚Ø¯ÛŒÙ…)
    let { data: teacher, error: teacherError } = await supabase
      .from('teachers')
      .select('id')
      .eq('name', input.teacher_name)
      .single();

    if (teacherError && teacherError.code === 'PGRST116') {
      const { data: newTeacher, error: createTeacherError } = await supabase
        .from('teachers')
        .insert({ name: input.teacher_name })
        .select('id')
        .single();
      if (createTeacherError) throw new Error(`Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ Ø§Ø³ØªØ§Ø¯: ${createTeacherError.message}`);
      teacher = newTeacher;
    } else if (teacherError) {
      throw new Error(`Ø®Ø·Ø§ Ø¯Ø± ÛŒØ§ÙØªÙ† Ø§Ø³ØªØ§Ø¯: ${teacherError.message}`);
    }

    // 8. Create/Update lesson_video (Ø¨Ø¯ÙˆÙ† Ù†ÛŒØ§Ø² Ø¨Ù‡ lesson)
    const styleMap: Record<string, 'note' | 'book' | 'sample'> = {
      'note': 'note',
      'book': 'book',
      'sample': 'sample',
      'Ø¬Ø²ÙˆÙ‡': 'note',
      'Ú©ØªØ§Ø¨ Ø¯Ø±Ø³ÛŒ': 'book',
      'Ù†Ù…ÙˆÙ†Ù‡ Ø³ÙˆØ§Ù„': 'sample',
    };
    const normalizedStyle = styleMap[String(input.style)] ?? 'note';

    const { data: lessonVideo, error: lessonVideoError } = await supabase
      .from('lesson_videos')
      .upsert({
        chapter_id: chapter.id,
        chapter_order: input.chapter_order,
        chapter_title: input.chapter_title,
        lesson_order: input.lesson_order,
        lesson_title: input.lesson_title,
        teacher_id: teacher.id,
        style: normalizedStyle,
        aparat_url: input.aparat_url || '',
        duration_sec: input.duration_sec,
        tags: input.tags || [],
        prereq_lesson_id: input.prereq_lesson_id || null,
        content_status: input.content_status || 'published',
        active: input.active !== false,
        embed_html: input.embed_html || null,
        allow_landscape: input.allow_landscape !== false,
        note_pdf_url: input.note_pdf_url ?? null,
        exercise_pdf_url: input.exercise_pdf_url ?? null
      }, {
        onConflict: 'chapter_id,lesson_order,lesson_title,teacher_id,style',
        ignoreDuplicates: false
      })
      .select('id')
      .single();

    if (lessonVideoError) {
      throw new Error(`Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ ÙˆÛŒØ¯ÛŒÙˆ Ø¯Ø±Ø³: ${lessonVideoError.message}`);
    }

    return new Response(
      JSON.stringify({ 
        success: true, 
        message: "Ù…Ø­ØªÙˆØ§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯",
        data: {
          branch_id: branch.id,
          grade_id: grade.id,
          track_id: track?.id || null,
          subject_id: subject.id,
          subject_offer_id: subjectOffer.id,
          chapter_id: chapter.id,
          teacher_id: teacher.id,
          lesson_video_id: lessonVideo.id
        }
      }),
      { status: 200, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
    );

  } catch (error) {
    console.error("Error in create-content function:", error);
    return new Response(
      JSON.stringify({ error: (error as Error).message }),
      { status: 500, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
    );
  }
});
```

---

## 3. Edge Function: update-content/index.ts (ØªØºÛŒÛŒØ±Ø§Øª)

### ØªØºÛŒÛŒØ± select Ø¯Ø± check (Ø®Ø· 53):
```typescript
// ØªØºÛŒÛŒØ± Ø§Ø²:
.select('id, teacher_id, lesson_id')

// Ø¨Ù‡:
.select('id, teacher_id, chapter_id')
```

### ØªØºÛŒÛŒØ± select (Ø®Ø·ÙˆØ· 108-132):

```typescript
// ØªØºÛŒÛŒØ± Ø§Ø²:
.select(`
  id,
  aparat_url,
  duration_sec,
  tags,
  prereq_lesson_id,
  active,
  content_status,
  style,
  view_count,
  teachers!inner(name),
  lessons!inner(
    title,
    chapters!inner(
      title,
      chapter_order,
      subject_offers!inner(
        subjects!inner(name, slug),
        grades!inner(name),
        tracks(name)
      )
    )
  )
`)

// Ø¨Ù‡:
.select(`
  id,
  chapter_id,
  chapter_order,
  chapter_title,
  lesson_order,
  lesson_title,
  aparat_url,
  duration_sec,
  tags,
  prereq_lesson_id,
  active,
  content_status,
  style,
  view_count,
  embed_html,
  allow_landscape,
  note_pdf_url,
  exercise_pdf_url,
  teachers!inner(name)
`)
```

---

## 4. Flutter Model: lesson_video.dart (Ú©Ø§Ù…Ù„)

```dart
class LessonVideo {
  final int id;
  final int chapterId;  // â† Ø¬Ø¯ÛŒØ¯
  final int chapterOrder;  // â† Ø¬Ø¯ÛŒØ¯
  final String chapterTitle;  // â† Ø¬Ø¯ÛŒØ¯
  final int lessonOrder;  // â† Ø¬Ø¯ÛŒØ¯
  final String lessonTitle;  // â† Ø¬Ø¯ÛŒØ¯
  final int teacherId;
  final String style;
  final String aparatUrl;
  final int durationSec;
  final int viewCount;
  final List<String> tags;
  final String contentStatus;
  final bool active;
  final String? embedHtml;
  final bool allowLandscape;
  final String? notePdfUrl;
  final String? exercisePdfUrl;

  LessonVideo({
    required this.id,
    required this.chapterId,
    required this.chapterOrder,
    required this.chapterTitle,
    required this.lessonOrder,
    required this.lessonTitle,
    required this.teacherId,
    required this.style,
    required this.aparatUrl,
    required this.durationSec,
    required this.viewCount,
    required this.tags,
    required this.contentStatus,
    required this.active,
    this.embedHtml,
    this.allowLandscape = true,
    this.notePdfUrl,
    this.exercisePdfUrl,
  });

  factory LessonVideo.fromJson(Map<String, dynamic> json) {
    return LessonVideo(
      id: json['id'] as int,
      chapterId: json['chapter_id'] as int,
      chapterOrder: json['chapter_order'] as int,
      chapterTitle: json['chapter_title'] as String,
      lessonOrder: json['lesson_order'] as int,
      lessonTitle: json['lesson_title'] as String,
      teacherId: json['teacher_id'] as int,
      style: json['style'] as String,
      aparatUrl: json['aparat_url'] as String,
      durationSec: (json['duration_sec'] as num).toInt(),
      viewCount: (json['view_count'] as num).toInt(),
      tags: ((json['tags'] as List?) ?? const [])
          .map((e) => e.toString())
          .toList(),
      contentStatus: json['content_status'] as String,
      active: (json['active'] as bool?) ?? true,
      embedHtml: json['embed_html'] as String?,
      allowLandscape: (json['allow_landscape'] as bool?) ?? true,
      notePdfUrl: json['note_pdf_url'] as String?,
      exercisePdfUrl: json['exercise_pdf_url'] as String?,
    );
  }

  Map<String, dynamic> toJson() {
    return {
      'id': id,
      'chapter_id': chapterId,
      'chapter_order': chapterOrder,
      'chapter_title': chapterTitle,
      'lesson_order': lessonOrder,
      'lesson_title': lessonTitle,
      'teacher_id': teacherId,
      'style': style,
      'aparat_url': aparatUrl,
      'duration_sec': durationSec,
      'view_count': viewCount,
      'tags': tags,
      'content_status': contentStatus,
      'active': active,
      'embed_html': embedHtml,
      'allow_landscape': allowLandscape,
      'note_pdf_url': notePdfUrl,
      'exercise_pdf_url': exercisePdfUrl,
    };
  }
}
```

---

## 5. Flutter Service: cached_content_service.dart (ØªØºÛŒÛŒØ±Ø§Øª)

### ØªØºÛŒÛŒØ± getLessonVideos:

```dart
/// Ø¯Ø±ÛŒØ§ÙØª ÙˆÛŒØ¯ÛŒÙˆÙ‡Ø§ÛŒ Ø¯Ø±Ø³ Ø§Ø² Mini-Request Hive Box
static Future<List<LessonVideo>> getLessonVideos(
  int chapterId, {  // â† ØªØºÛŒÛŒØ± Ø§Ø² lessonId Ø¨Ù‡ chapterId
  required int gradeId,
  int? trackId,
}) async {
  final boxName = _getMiniRequestBoxName(gradeId, trackId);
  
  Logger.info('ğŸš€ [MINI-REQUEST] Loading videos from Hive for chapter: $chapterId');
  
  try {
    final box = await Hive.openBox(boxName);
    final videosJson = box.get('videos');
    
    if (videosJson == null) {
      Logger.info('âš ï¸ [MINI-REQUEST] No videos in Hive');
      return [];
    }
    
    final Map<String, dynamic> allVideos = jsonDecode(videosJson);
    List<dynamic>? videosList = allVideos[chapterId.toString()];  // â† ØªØºÛŒÛŒØ± Ø§Ø² lessonId
    
    if (videosList == null || videosList.isEmpty) return [];
    
    return videosList.map((j) => LessonVideo.fromJson(j)).toList();
  } catch (e) {
    Logger.error('âŒ [MINI-REQUEST] Error reading videos from Hive', e);
    return [];
  }
}
```

### Ø­Ø°Ù getLessons (Ø®Ø·ÙˆØ· 107-137):
Ø§ÛŒÙ† Ù…ØªØ¯ Ú©Ø§Ù…Ù„ Ø­Ø°Ù Ù…ÛŒâ€ŒØ´ÙˆØ¯.

---

## 6. Flutter Service: content_service.dart (ØªØºÛŒÛŒØ±Ø§Øª)

### ØªØºÛŒÛŒØ± getLessonVideos:

```dart
Future<List<LessonVideo>> getLessonVideos(int chapterId) async {  // â† ØªØºÛŒÛŒØ± Ø§Ø² lessonId
  final data = await _supabase
      .from('lesson_videos')
      .select()
      .eq('chapter_id', chapterId)  // â† ØªØºÛŒÛŒØ± Ø§Ø² lesson_id
      .eq('active', true)
      .order('lesson_order', ascending: true)
      .order('style', ascending: true);
  
  return data.map((j) => LessonVideo.fromJson(j as Map<String, dynamic>)).toList();
}
```

### Ø­Ø°Ù getLessons (Ø®Ø· 145):
Ø§ÛŒÙ† Ù…ØªØ¯ Ú©Ø§Ù…Ù„ Ø­Ø°Ù Ù…ÛŒâ€ŒØ´ÙˆØ¯.

---

## 7. Flutter Service: mini_request_service.dart (ØªØºÛŒÛŒØ±Ø§Øª)

### Ø­Ø°Ù _loadLessonsMetadata (Ø®Ø·ÙˆØ· 668-722):
Ø§ÛŒÙ† Ù…ØªØ¯ Ú©Ø§Ù…Ù„ Ø­Ø°Ù Ù…ÛŒâ€ŒØ´ÙˆØ¯.

### ØªØºÛŒÛŒØ± _loadVideosMetadata (Ø®Ø·ÙˆØ· 724-802):

```dart
/// Ø¯Ø±ÛŒØ§ÙØª Ùˆ Ú©Ø´ Ú©Ø±Ø¯Ù† videos (metadata) Ø¨Ø±Ø§ÛŒ ØªÙ…Ø§Ù… chapters
Future<void> _loadVideosMetadata(int grade, int? track) async {
  try {
    Logger.info('ğŸ¥ [MINI-REQUEST] Loading videos metadata: grade=$grade track=$track');
    
    // Ø¯Ø±ÛŒØ§ÙØª chapters Ø§Ø² Hive
    final boxName = _getBoxName(grade, track);
    final box = await Hive.openBox(boxName);
    final chaptersJson = box.get('chapters');
    
    if (chaptersJson == null) {
      Logger.info('âš ï¸ [MINI-REQUEST] No chapters found, cannot load videos');
      return;
    }
    
    final Map<String, dynamic> allChapters = jsonDecode(chaptersJson);
    if (allChapters.isEmpty) {
      Logger.info('âš ï¸ [MINI-REQUEST] Chapters map is empty, skipping videos');
      return;
    }
    
    // Ø¨Ø±Ø§ÛŒ Ù‡Ø± chapterØŒ videos Ø±Ø§ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ú©Ù†
    final Map<String, List<dynamic>> videosByChapter = {};  // â† ØªØºÛŒÛŒØ± Ø§Ø² videosByLesson
    
    // ØªÙ…Ø§Ù… chapters Ø±Ø§ Ø§Ø² Ù‡Ù…Ù‡ subject_offers Ø¬Ù…Ø¹ Ú©Ù† (Ø³Ø§Ø¯Ù‡â€ŒØªØ± Ø¨Ø§ expand)
    final allChaptersList = allChapters.values
        .expand((chaptersList) => chaptersList is List ? chaptersList : [])
        .whereType<Map<String, dynamic>>()
        .toList();
    
    Logger.debug('ğŸ¥ [MINI-REQUEST] Found ${allChaptersList.length} chapters to load videos for');
    
    for (final chapter in allChaptersList) {
      try {
        // Query videos Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† chapter (Ø¨Ù‡ Ø¬Ø§ÛŒ lesson)
        final videosData = await _supabase
            .from('lesson_videos')
            .select()
            .eq('chapter_id', chapter['id'])  // â† ØªØºÛŒÛŒØ± Ø§Ø² lesson_id
            .eq('active', true)
            .order('lesson_order', ascending: true)
            .order('style', ascending: true)
            as List<dynamic>;
        
        videosByChapter[chapter['id'].toString()] = videosData;  // â† ØªØºÛŒÛŒØ± Ø§Ø² lessonId
      } catch (e) {
        Logger.error('âŒ [MINI-REQUEST] Error loading videos for chapter ${chapter['id']}', e);
      }
    }
    
    // Ø°Ø®ÛŒØ±Ù‡ videos Ø¯Ø± Hive Ø¨Ù‡ ØµÙˆØ±Øª Map: {chapterId: [videos]}
    await box.put('videos', jsonEncode(videosByChapter));
  } catch (e) {
    Logger.error('âŒ [MINI-REQUEST] Error loading videos metadata', e);
  }
}
```

---

## 8. Flutter UI: chapter_screen.dart (ØªØºÛŒÛŒØ±Ø§Øª Ø§ØµÙ„ÛŒ)

### ØªØºÛŒÛŒØ± State:

```dart
class _ChapterScreenState extends State<ChapterScreen> {
  bool _loading = false;
  List<LessonVideo> _allVideos = [];  // â† ØªØºÛŒÛŒØ± Ø§Ø² _lessons Ùˆ _videosByLesson
  String _selectedStyle = 'Ø¬Ø²ÙˆÙ‡';
  Map<String, String> _teachersMap = {};
  // ...
}
```

### ØªØºÛŒÛŒØ± _load:

```dart
Future<void> _load() async {
  setState(() => _loading = true);
  
  try {
    // Ù…Ø³ØªÙ‚ÛŒÙ…Ø§Ù‹ ÙˆÛŒØ¯ÛŒÙˆÙ‡Ø§ Ø±Ø§ Ø§Ø² chapter Ù…ÛŒâ€ŒÚ¯ÛŒØ±ÛŒÙ… (Ø¨Ø¯ÙˆÙ† Ù†ÛŒØ§Ø² Ø¨Ù‡ lessons)
    final videos = await CachedContentService.getLessonVideos(
      widget.chapter.id,  // chapterId Ø¨Ù‡ Ø¬Ø§ÛŒ lessonId
      gradeId: widget.gradeId,
      trackId: widget.trackId,
    );

    if (!mounted) return;
    setState(() {
      _allVideos = videos;
      _loading = false;
    });
  } catch (e) {
    Logger.error('Error loading videos', e);
    if (mounted) {
      setState(() => _loading = false);
    }
  }
}
```

### ØªØºÛŒÛŒØ± build (Ø¨Ø®Ø´ Ù„ÛŒØ³Øª):

```dart
// Ø¯Ø± build methodØŒ Ø¨Ù‡ Ø¬Ø§ÛŒ Ù…Ù†Ø·Ù‚ Ù¾ÛŒÚ†ÛŒØ¯Ù‡ grouping:
: RefreshIndicator(
    onRefresh: () async {
      AppCacheManager.clearCache('videos_chapter_${widget.chapter.id}');  // â† ØªØºÛŒÛŒØ± cache key
      await _load();
    },
    child: _allVideos.isEmpty
        ? SingleChildScrollView(
            physics: AppScrollPhysics.smooth,
            child: Center(
              child: Padding(
                padding: const EdgeInsets.all(32.0),
                child: EmptyStateWidgets.noLessonContent(context),
              ),
            ),
          )
        : _buildVideosList(context, theme, darkBlue),
  )

// Ù…ØªØ¯ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ø³Ø§Ø®Øª Ù„ÛŒØ³Øª ÙˆÛŒØ¯ÛŒÙˆÙ‡Ø§ (Ø³Ø§Ø¯Ù‡â€ŒØªØ±)
Widget _buildVideosList(BuildContext context, ThemeData theme, Color darkBlue) {
  // ÙÛŒÙ„ØªØ± Ø¨Ø± Ø§Ø³Ø§Ø³ style Ø§Ù†ØªØ®Ø§Ø¨ÛŒ
  final filteredVideos = _allVideos
      .where((v) => _getStyleName(v.style) == _selectedStyle)
      .toList();
  
  // Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ lesson_order Ùˆ Ø³Ù¾Ø³ lesson_title
  filteredVideos.sort((a, b) {
    final orderCompare = a.lessonOrder.compareTo(b.lessonOrder);
    if (orderCompare != 0) return orderCompare;
    return a.lessonTitle.compareTo(b.lessonTitle);
  });

  if (filteredVideos.isEmpty) {
    return SingleChildScrollView(
      physics: AppScrollPhysics.smooth,
      child: Center(
        child: Padding(
          padding: const EdgeInsets.all(32.0),
          child: EmptyStateWidgets.noEducationContent(context),
        ),
      ),
    );
  }

  return ListView.builder(
    physics: AppScrollPhysics.gentle,
    padding: const EdgeInsets.symmetric(horizontal: 16),
    itemCount: filteredVideos.length,
    itemBuilder: (ctx, i) {
      final video = filteredVideos[i];
      final teacherName = _teachersMap[video.teacherId.toString()] ?? 'Ù†Ø§Ù…Ø´Ø®Øµ';
      final styleName = _getStyleName(video.style);
      final title = '${video.lessonTitle} - $teacherName - $styleName';
      
      return _buildVideoCard(
        video: video,
        title: title,
        theme: theme,
        darkBlue: darkBlue,
      );
    },
  );
}
```

### ØªØºÛŒÛŒØ± Ù…ØªØ¯Ù‡Ø§ÛŒ Ø¯ÛŒÚ¯Ø± Ø¯Ø± chapter_screen:

```dart
// ØªØºÛŒÛŒØ± _buildVideoCard (Ø­Ø°Ù ÙˆØ§Ø¨Ø³ØªÚ¯ÛŒ Ø¨Ù‡ Lesson):
Widget _buildVideoCard(
  LessonVideo video,
  String title,
  ThemeData theme,
  Color darkBlue,
) {
  // Ø­Ø°Ù: final lesson = _lessons!.firstWhere(...)
  // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…Ø³ØªÙ‚ÛŒÙ… Ø§Ø² video.lessonTitle Ùˆ video.lessonOrder
  
  return GestureDetector(
    onTap: () {
      if (video.embedHtml != null && video.embedHtml!.isNotEmpty) {
        _openVideoPopup(video);
      } else {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(
            content: Text(
              'ÙˆÛŒØ¯ÛŒÙˆ Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³Øª',
              textAlign: TextAlign.right,
              textDirection: TextDirection.rtl,
              style: TextStyle(fontFamily: 'IRANSansXFaNum'),
            ),
            backgroundColor: Colors.red,
          ),
        );
      }
    },
    child: Container(
      // ... Ú©Ø¯ Ú©Ø§Ø±Øª ÙˆÛŒØ¯ÛŒÙˆ
      // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² video.lessonTitle Ø¨Ù‡ Ø¬Ø§ÛŒ lesson.title
      // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² video.lessonOrder Ø¨Ù‡ Ø¬Ø§ÛŒ lesson.lessonOrder
    ),
  );
}

// ØªØºÛŒÛŒØ± _openVideoPopup (Ø­Ø°Ù ÙˆØ§Ø¨Ø³ØªÚ¯ÛŒ Ø¨Ù‡ Lesson):
void _openVideoPopup(LessonVideo video) {
  final teacherName = _teachersMap[video.teacherId.toString()] ?? 'Ù†Ø§Ù…Ø´Ø®Øµ';
  
  showDialog(
    context: context,
    builder: (context) => Directionality(
      textDirection: TextDirection.rtl,
      child: AlertDialog(
        title: const Text(
          'Ø¬Ø²Ø¦ÛŒØ§Øª ÙˆÛŒØ¯ÛŒÙˆ',
          style: TextStyle(fontFamily: 'IRANSansXFaNum'),
        ),
        content: SizedBox(
          width: double.maxFinite,
          child: SingleChildScrollView(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              mainAxisSize: MainAxisSize.min,
              children: [
                _kv('Ø´Ù†Ø§Ø³Ù‡ ÙˆÛŒØ¯ÛŒÙˆ', video.id.toString()),
                _kv('Ø¯Ø±Ø³', video.lessonTitle),  // â† Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…Ø³ØªÙ‚ÛŒÙ… Ø§Ø² video.lessonTitle
                _kv('Ø§Ø³ØªØ§Ø¯', teacherName),
                _kv('Ù†ÙˆØ¹ Ù…Ø­ØªÙˆØ§', _getStyleName(video.style)),
                _kv('ÙˆØ¶Ø¹ÛŒØª Ù…Ø­ØªÙˆØ§', video.contentStatus),
                _kv('Ù„ÛŒÙ†Ú© Ø¢Ù¾Ø§Ø±Ø§Øª', video.aparatUrl.isNotEmpty ? video.aparatUrl : '-'),
                _kv('Ù…Ø¯Øª Ø²Ù…Ø§Ù†', _formatDuration(video.durationSec)),
                _kv('ØªÚ¯â€ŒÙ‡Ø§', video.tags.isNotEmpty ? video.tags.join(', ') : '-'),
                if (video.notePdfUrl != null && video.notePdfUrl!.isNotEmpty)
                  _kv('Ù„ÛŒÙ†Ú© PDF Ø¬Ø²ÙˆÙ‡', video.notePdfUrl!),
                if (video.exercisePdfUrl != null && video.exercisePdfUrl!.isNotEmpty)
                  _kv('Ù„ÛŒÙ†Ú© PDF Ù†Ù…ÙˆÙ†Ù‡ Ø³ÙˆØ§Ù„', video.exercisePdfUrl!),
              ],
            ),
          ),
        ),
        actions: [
          ElevatedButton(
            onPressed: () => Navigator.of(context).pop(),
            style: ElevatedButton.styleFrom(
              backgroundColor: Colors.green,
              foregroundColor: Colors.white,
            ),
            child: const Text('ÙˆÛŒØ±Ø§ÛŒØ´', style: TextStyle(fontFamily: 'IRANSansXFaNum')),
          ),
          ElevatedButton(
            onPressed: () => Navigator.of(context).pop(),
            style: ElevatedButton.styleFrom(
              backgroundColor: Colors.red,
              foregroundColor: Colors.white,
            ),
            child: const Text('Ø­Ø°Ù', style: TextStyle(fontFamily: 'IRANSansXFaNum')),
          ),
        ],
      ),
    ),
  );
}
```

---

## âš ï¸ Ù†Ú©Ø§Øª Ù…Ù‡Ù… Ùˆ Ù…Ø´Ú©Ù„Ø§Øª Ø§Ø­ØªÙ…Ø§Ù„ÛŒ

### 1. Migration SQL - Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ¬ÙˆØ¯
- **Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¬Ø±Ø§ÛŒ migration**: Ø­ØªÙ…Ø§Ù‹ backup Ø¨Ú¯ÛŒØ±ÛŒØ¯
- **Ú¯Ø§Ù… 2.5**: Ø§Ú¯Ø± Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§ÛŒ Ø¨Ø¯ÙˆÙ† `lesson_id` ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ù†Ø¯ØŒ Ø­Ø°Ù Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯
- **Ú¯Ø§Ù… 3**: Ø§Ú¯Ø± UPDATE Ù…ÙˆÙÙ‚ Ù†Ø¨ÙˆØ¯ØŒ NOT NULL Ø®Ø·Ø§ Ù…ÛŒâ€ŒØ¯Ù‡Ø¯
- **Ú¯Ø§Ù… 4.5**: âœ… Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯ - Ø­Ø°Ù FK `prereq_lesson_id` Ù‚Ø¨Ù„ Ø§Ø² Ø­Ø°Ù lessons
- **Ú¯Ø§Ù… 5**: âœ… Ø§ØµÙ„Ø§Ø­ Ø´Ø¯ - Ø§Ø¨ØªØ¯Ø§ constraint Ù‚Ø¯ÛŒÙ…ÛŒ Ø­Ø°Ù Ù…ÛŒâ€ŒØ´ÙˆØ¯ØŒ Ø³Ù¾Ø³ constraint Ø¬Ø¯ÛŒØ¯ Ø§Ø¶Ø§ÙÙ‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯

### 2. Edge Function create-content
- **onConflict**: âœ… Ø§ØµÙ„Ø§Ø­ Ø´Ø¯ - Ø¨Ø§ÛŒØ¯ Ø³ØªÙˆÙ†â€ŒÙ‡Ø§ÛŒ constraint Ø±Ø§ Ù…Ø´Ø®Øµ Ú©Ù†ÛŒÙ… (`chapter_id,lesson_order,lesson_title,teacher_id,style`)
- **ignoreDuplicates**: âœ… Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯ - Ø¨Ø§ÛŒØ¯ `false` Ø¨Ø§Ø´Ø¯ ØªØ§ Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§ÛŒ Ù…ÙˆØ¬ÙˆØ¯ update Ø´ÙˆÙ†Ø¯
- **ØªØ³Øª**: Ø¨Ø¹Ø¯ Ø§Ø² deployØŒ Ø­ØªÙ…Ø§Ù‹ ØªØ³Øª Ú©Ù†ÛŒØ¯ Ú©Ù‡ upsert Ø¯Ø±Ø³Øª Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ø¯

### 3. Edge Function update-content
- **Ø®Ø· 53**: Ø¨Ø§ÛŒØ¯ `lesson_id` Ø±Ø§ Ø¨Ù‡ `chapter_id` ØªØºÛŒÛŒØ± Ø¯Ù‡ÛŒØ¯
- **Ø®Ø· 108-131**: select query Ø¨Ø§ÛŒØ¯ ØªØºÛŒÛŒØ± Ú©Ù†Ø¯ (Ø­Ø°Ù `lessons!inner`)

### 4. Flutter Model lesson_video.dart
- **ØªÙˆØ¬Ù‡**: ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ (`chapterId`, `chapterOrder`, `chapterTitle`, `lessonOrder`, `lessonTitle`) Ø¨Ø§ÛŒØ¯ Ø§Ø¶Ø§ÙÙ‡ Ø´ÙˆÙ†Ø¯
- **Ø§Ø²**: `lessonId` Ø¨Ø§ÛŒØ¯ Ø­Ø°Ù Ø´ÙˆØ¯

### 5. Flutter Services
- **cached_content_service.dart**: Ù…ØªØ¯ `getLessons` Ø¨Ø§ÛŒØ¯ Ø­Ø°Ù Ø´ÙˆØ¯ (Ø§Ù…Ø§ Ù…Ù…Ú©Ù† Ø§Ø³Øª Ø¯Ø± `subject_screen` ÛŒØ§ `dev_settings` Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø´ÙˆØ¯ - Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯)
- **content_service.dart**: Ù…ØªØ¯ `getLessons` Ø¨Ø§ÛŒØ¯ Ø­Ø°Ù Ø´ÙˆØ¯

### 6. Flutter UI chapter_screen.dart
- **ØªØºÛŒÛŒØ±Ø§Øª Ø¨Ø²Ø±Ú¯**: Ø¯ÛŒÚ¯Ø± Ø§Ø² `Lesson` Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯
- **Ø­Ø°Ù**: `_lessons` Ùˆ `_videosByLesson` state variables
- **Ø§Ø¶Ø§ÙÙ‡**: ÙÙ‚Ø· `_allVideos` (List<LessonVideo>)
- **ØªØºÛŒÛŒØ±**: ØªÙ…Ø§Ù… Ø¬Ø§Ù‡Ø§ÛŒÛŒ Ú©Ù‡ Ø§Ø² `lesson.title` Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ â†’ `video.lessonTitle`
- **ØªØºÛŒÛŒØ±**: ØªÙ…Ø§Ù… Ø¬Ø§Ù‡Ø§ÛŒÛŒ Ú©Ù‡ Ø§Ø² `lesson.lessonOrder` Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ â†’ `video.lessonOrder`

### 7. ØµÙØ­Ø§Øª Ø¯ÛŒÚ¯Ø± Ú©Ù‡ Ù…Ù…Ú©Ù† Ø§Ø³Øª Ù†ÛŒØ§Ø² Ø¨Ù‡ ØªØºÛŒÛŒØ± Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ù†Ø¯
- **subject_screen.dart**: Ø§Ú¯Ø± Ø§Ø² `getLessons` Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†Ø¯ØŒ Ø¨Ø§ÛŒØ¯ Ø¨Ø±Ø±Ø³ÛŒ Ø´ÙˆØ¯
- **dev_settings_button.dart**: Ø§Ú¯Ø± Ø§Ø² `getLessons` Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†Ø¯ØŒ Ø¨Ø§ÛŒØ¯ Ø¨Ø±Ø±Ø³ÛŒ Ø´ÙˆØ¯

### 8. ØªØ±ØªÛŒØ¨ Ø§Ø¬Ø±Ø§ÛŒ Ù…Ø±Ø§Ø­Ù„
1. âœ… Migration SQL (Ø§ÙˆÙ„ Ø§Ø² Ù‡Ù…Ù‡)
2. âœ… Deploy Migration
3. âœ… Edge Function create-content
4. âœ… Deploy create-content
5. âœ… Edge Function update-content  
6. âœ… Deploy update-content
7. âœ… Flutter Model
8. âœ… Flutter Services
9. âœ… Flutter UI
10. âœ… Flutter Analyze

---

## âš ï¸ Ù…Ø´Ú©Ù„Ø§Øª Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ø´Ø¯Ù‡ Ùˆ Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡

### âœ… Ù…Ø´Ú©Ù„Ø§Øª Ø¨Ø±Ø·Ø±Ù Ø´Ø¯Ù‡:

1. **Migration SQL - Constraint unique_lesson_video**
   - âœ… Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯: `DROP CONSTRAINT IF EXISTS unique_lesson_video` Ù‚Ø¨Ù„ Ø§Ø² Ø§ÛŒØ¬Ø§Ø¯
   - âœ… Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯: Ø­Ø°Ù FK `prereq_lesson_id` Ù‚Ø¨Ù„ Ø§Ø² Ø­Ø°Ù lessons

2. **Edge Function create-content - onConflict**
   - âœ… Ø§ØµÙ„Ø§Ø­ Ø´Ø¯: Ø§Ø² `onConflict: 'unique_lesson_video'` Ø¨Ù‡ `onConflict: 'chapter_id,lesson_order,lesson_title,teacher_id,style'`
   - âœ… Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯: `ignoreDuplicates: false` Ø¨Ø±Ø§ÛŒ update Ú©Ø±Ø¯Ù† Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§ÛŒ Ù…ÙˆØ¬ÙˆØ¯

### âœ… Ù…Ø´Ú©Ù„Ø§Øª Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡ - Ø±Ø§Ù‡â€ŒØ­Ù„â€ŒÙ‡Ø§ÛŒ Ø³Ø§Ø¯Ù‡:

3. **prereq_lesson_id** âœ… Ø­Ù„ Ø´Ø¯
   - âœ… ØªØµÙ…ÛŒÙ…: ÙÛŒÙ„Ø¯ Ø±Ø§ Ù†Ú¯Ù‡ Ù…ÛŒâ€ŒØ¯Ø§Ø±ÛŒÙ… Ø§Ù…Ø§ foreign key Ø±Ø§ Ø­Ø°Ù Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… (Ù‚Ø¨Ù„Ø§Ù‹ Ø¯Ø± Migration Ú¯Ø§Ù… 4.5 Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯)
   - âœ… Ø¯Ù„ÛŒÙ„: Ø¯Ø± Ú©Ø¯ Flutter Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯ØŒ Ø§Ù…Ø§ Ù…Ù…Ú©Ù† Ø§Ø³Øª Ø¯Ø± Ø¢ÛŒÙ†Ø¯Ù‡ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø´ÙˆØ¯
   - âœ… Ù†ØªÛŒØ¬Ù‡: ÙÙ‚Ø· foreign key Ø­Ø°Ù Ù…ÛŒâ€ŒØ´ÙˆØ¯ØŒ ÙÛŒÙ„Ø¯ Ø¨Ø§Ù‚ÛŒ Ù…ÛŒâ€ŒÙ…Ø§Ù†Ø¯

4. **Flutter - subject_screen.dart** âœ… Ø±Ø§Ù‡â€ŒØ­Ù„ Ø³Ø§Ø¯Ù‡ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯
   - âœ… ØªØºÛŒÛŒØ±: Ù…Ø³ØªÙ‚ÛŒÙ…Ø§Ù‹ Ø§Ø² `getLessonVideos(chapter.id)` Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
   - âœ… Ú©Ø¯ Ú©Ø§Ù…Ù„ Ø¯Ø± Ø¨Ø®Ø´ 9

5. **Flutter - dev_settings_button.dart** âœ… Ø±Ø§Ù‡â€ŒØ­Ù„ Ø³Ø§Ø¯Ù‡ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯
   - âœ… ØªØºÛŒÛŒØ±: Ø­Ù„Ù‚Ù‡ `lessons` Ø­Ø°Ù Ù…ÛŒâ€ŒØ´ÙˆØ¯ØŒ Ù…Ø³ØªÙ‚ÛŒÙ…Ø§Ù‹ `getLessonVideos(ch.id)` ØµØ¯Ø§ Ø²Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯
   - âœ… Ú©Ø¯ Ú©Ø§Ù…Ù„ Ø¯Ø± Ø¨Ø®Ø´ 10

6. **Flutter - mini_request_service.dart** âœ… Ø±Ø§Ù‡â€ŒØ­Ù„ Ø³Ø§Ø¯Ù‡ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯
   - âœ… ØªØºÛŒÛŒØ±: `_loadLessonsMetadata` Ø­Ø°Ù Ù…ÛŒâ€ŒØ´ÙˆØ¯ØŒ `_loadVideosMetadata` Ø§Ø² `chapters` Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†Ø¯
   - âœ… Ú©Ø¯ Ú©Ø§Ù…Ù„ Ø¯Ø± Ø¨Ø®Ø´ 11

---

## 9. Flutter UI: subject_screen.dart (Ú©Ø¯ Ú©Ø§Ù…Ù„ ØªØºÛŒÛŒØ±Ø§Øª)

### ØªØºÛŒÛŒØ± Ù…ØªØ¯ _loadChapterTeachers:

```dart
// Ù„ÙˆØ¯ Ú©Ø±Ø¯Ù† ÙˆÛŒØ¯ÛŒÙˆÙ‡Ø§ÛŒ Ù‡Ø± ÙØµÙ„ Ø¨Ø±Ø§ÛŒ Ú¯Ø±ÙØªÙ† Ù†Ø§Ù… ÙˆØ§Ù‚Ø¹ÛŒ Ø§Ø³Ø§ØªÛŒØ¯
Future<void> _loadChapterTeachers(List<Chapter> chapters) async {
  _chapterTeachers.clear();

  for (final chapter in chapters) {
    try {
      // âœ… ØªØºÛŒÛŒØ±: Ù…Ø³ØªÙ‚ÛŒÙ…Ø§Ù‹ ÙˆÛŒØ¯ÛŒÙˆÙ‡Ø§ Ø±Ø§ Ø§Ø² chapter Ù…ÛŒâ€ŒÚ¯ÛŒØ±ÛŒÙ… (Ø¨Ø¯ÙˆÙ† Ù†ÛŒØ§Ø² Ø¨Ù‡ lessons)
      final videos = await CachedContentService.getLessonVideos(
        chapter.id,  // â† ØªØºÛŒÛŒØ± Ø§Ø² lesson.id Ø¨Ù‡ chapter.id
        gradeId: widget.gradeId,
        trackId: widget.trackId,
      );

      // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù†Ø§Ù…â€ŒÙ‡Ø§ÛŒ Ù…Ù†Ø­ØµØ± Ø¨Ù‡ ÙØ±Ø¯ Ø§Ø³Ø§ØªÛŒØ¯
      final Set<String> teacherNames = {};

      // âœ… ØªØºÛŒÛŒØ±: Ù…Ø³ØªÙ‚ÛŒÙ…Ø§Ù‹ Ø§Ø² videos Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… (Ø¨Ø¯ÙˆÙ† Ø­Ù„Ù‚Ù‡ lessons)
      for (final video in videos) {
        // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² teacherId Ø¨Ø±Ø§ÛŒ Ú¯Ø±ÙØªÙ† Ù†Ø§Ù… Ø§Ø³ØªØ§Ø¯
        final teacherName = _getTeacherNameById(video.teacherId);
        if (teacherName.isNotEmpty) {
          teacherNames.add(teacherName);
        }
      }

      _chapterTeachers[chapter.id] = teacherNames.toList();
    } catch (e) {
      Logger.error('âŒ Error loading teachers for chapter ${chapter.id}', e);
      _chapterTeachers[chapter.id] = [];
    }
  }
}
```

---

## 10. Flutter UI: dev_settings_button.dart (Ú©Ø¯ Ú©Ø§Ù…Ù„ ØªØºÛŒÛŒØ±Ø§Øª)

### ØªØºÛŒÛŒØ± Ù…ØªØ¯ Ú©Ø´ Ú©Ø±Ø¯Ù† Ø¯ÛŒØªØ§:

```dart
// âœ… ØªØºÛŒÛŒØ±: Ø­Ø°Ù Ø­Ù„Ù‚Ù‡ lessonsØŒ Ù…Ø³ØªÙ‚ÛŒÙ…Ø§Ù‹ Ø§Ø² chapters Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
for (final ch in chapters) {
  // âœ… ØªØºÛŒÛŒØ±: Ù…Ø³ØªÙ‚ÛŒÙ…Ø§Ù‹ getLessonVideos Ø±Ø§ ØµØ¯Ø§ Ù…ÛŒâ€ŒØ²Ù†ÛŒÙ…
  await CachedContentService.getLessonVideos(
    ch.id,  // â† ØªØºÛŒÛŒØ± Ø§Ø² les.id Ø¨Ù‡ ch.id
    gradeId: grade,
    trackId: track,
  );
}
```

**Ú©Ø¯ Ú©Ø§Ù…Ù„ Ù‚Ø¨Ù„ Ø§Ø² ØªØºÛŒÛŒØ±:**
```dart
for (final ch in chapters) {
  final lessons = await CachedContentService.getLessons(
    ch.id,
    gradeId: grade,
    trackId: track,
  );
  for (final les in lessons) {
    await CachedContentService.getLessonVideos(
      les.id,
      gradeId: grade,
      trackId: track,
    );
  }
}
```

**Ú©Ø¯ Ú©Ø§Ù…Ù„ Ø¨Ø¹Ø¯ Ø§Ø² ØªØºÛŒÛŒØ±:**
```dart
for (final ch in chapters) {
  await CachedContentService.getLessonVideos(
    ch.id,
    gradeId: grade,
    trackId: track,
  );
}
```

---

## 11. Flutter Service: mini_request_service.dart (Ú©Ø¯ Ú©Ø§Ù…Ù„ ØªØºÛŒÛŒØ±Ø§Øª)

### Ø­Ø°Ù Ù…ØªØ¯ _loadLessonsMetadata:
- âœ… Ø§ÛŒÙ† Ù…ØªØ¯ Ú©Ø§Ù…Ù„ Ø­Ø°Ù Ù…ÛŒâ€ŒØ´ÙˆØ¯ (Ø®Ø·ÙˆØ· 643-722)
- âœ… Ù‡ÛŒÚ† Ø¬Ø§ÛŒ Ø¯ÛŒÚ¯Ø±ÛŒ Ø§ÛŒÙ† Ù…ØªØ¯ Ø±Ø§ ØµØ¯Ø§ Ù†Ù…ÛŒâ€ŒØ²Ù†Ø¯ (Ø¨Ø±Ø±Ø³ÛŒ Ø´Ø¯Ù‡)

### ØªØºÛŒÛŒØ± Ù…ØªØ¯ _loadVideosMetadata:

```dart
/// Ø¯Ø±ÛŒØ§ÙØª Ùˆ Ú©Ø´ Ú©Ø±Ø¯Ù† videos (metadata) Ø¨Ø±Ø§ÛŒ ØªÙ…Ø§Ù… chapters
Future<void> _loadVideosMetadata(int grade, int? track) async {
  try {
    Logger.info('ğŸ¥ [MINI-REQUEST] Loading videos metadata: grade=$grade track=$track');
    
    // âœ… ØªØºÛŒÛŒØ±: Ø¯Ø±ÛŒØ§ÙØª chapters Ø§Ø² Hive (Ø¨Ù‡ Ø¬Ø§ÛŒ lessons)
    final boxName = _getBoxName(grade, track);
    final box = await Hive.openBox(boxName);
    final chaptersJson = box.get('chapters');  // â† ØªØºÛŒÛŒØ± Ø§Ø² 'lessons' Ø¨Ù‡ 'chapters'
    
    if (chaptersJson == null) {
      Logger.info('âš ï¸ [MINI-REQUEST] No chapters found, cannot load videos');
      return;
    }
    
    final Map<String, dynamic> allChapters = jsonDecode(chaptersJson);  // â† ØªØºÛŒÛŒØ± Ø§Ø² allLessons
    if (allChapters.isEmpty) {
      Logger.info('âš ï¸ [MINI-REQUEST] Chapters map is empty, skipping videos');
      return;
    }
    
    // âœ… ØªØºÛŒÛŒØ±: Ø¨Ø±Ø§ÛŒ Ù‡Ø± chapterØŒ videos Ø±Ø§ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ú©Ù† (Ø¨Ù‡ Ø¬Ø§ÛŒ lesson)
    final Map<String, List<dynamic>> videosByChapter = {};  // â† ØªØºÛŒÛŒØ± Ø§Ø² videosByLesson
    
    // ØªÙ…Ø§Ù… chapters Ø±Ø§ Ø§Ø² Ù‡Ù…Ù‡ subject_offers Ø¬Ù…Ø¹ Ú©Ù† (Ø³Ø§Ø¯Ù‡â€ŒØªØ± Ø¨Ø§ expand)
    final allChaptersList = allChapters.values
        .expand((chaptersList) => chaptersList is List ? chaptersList : [])
        .whereType<Map<String, dynamic>>()
        .toList();
    
    Logger.debug('ğŸ¥ [MINI-REQUEST] Found ${allChaptersList.length} chapters to load videos for');
    
    for (final chapter in allChaptersList) {
      try {
        // âœ… ØªØºÛŒÛŒØ±: Query videos Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† chapter (Ø¨Ù‡ Ø¬Ø§ÛŒ lesson)
        final videosData = await _supabase
            .from('lesson_videos')
            .select()
            .eq('chapter_id', chapter['id'])  // â† ØªØºÛŒÛŒØ± Ø§Ø² lesson_id Ø¨Ù‡ chapter_id
            .eq('active', true)
            .order('lesson_order', ascending: true)
            .order('style', ascending: true)
            as List<dynamic>;
        
        videosByChapter[chapter['id'].toString()] = videosData;  // â† ØªØºÛŒÛŒØ± Ø§Ø² lessonId
      } catch (e) {
        Logger.error('âŒ [MINI-REQUEST] Error loading videos for chapter ${chapter['id']}', e);
      }
    }
    
    // âœ… ØªØºÛŒÛŒØ±: Ø°Ø®ÛŒØ±Ù‡ videos Ø¯Ø± Hive Ø¨Ù‡ ØµÙˆØ±Øª Map: {chapterId: [videos]}
    await box.put('videos', jsonEncode(videosByChapter));
  } catch (e) {
    Logger.error('âŒ [MINI-REQUEST] Error loading videos metadata', e);
  }
}
```

### Ø­Ø°Ù ØµØ¯Ø§ Ø²Ø¯Ù† _loadLessonsMetadata:
- âœ… Ø§ÛŒÙ† Ù…ØªØ¯ Ø¯Ø± 2 Ø¬Ø§ ØµØ¯Ø§ Ø²Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ (Ø®Ø·ÙˆØ· 235 Ùˆ 267)
- âœ… Ø¨Ø§ÛŒØ¯ Ø§ÛŒÙ† Ø¯Ùˆ ØµØ¯Ø§ Ø²Ø¯Ù† Ø­Ø°Ù Ø´ÙˆÙ†Ø¯

**Ú©Ø¯ Ù‚Ø¨Ù„ Ø§Ø² ØªØºÛŒÛŒØ± (Ø®Ø·ÙˆØ· 230-240):**
```dart
await _loadChaptersMetadata(grade, track);
await _loadLessonsMetadata(grade, track);  // â† Ø¨Ø§ÛŒØ¯ Ø­Ø°Ù Ø´ÙˆØ¯
await _loadVideosMetadata(grade, track);
```

**Ú©Ø¯ Ø¨Ø¹Ø¯ Ø§Ø² ØªØºÛŒÛŒØ±:**
```dart
await _loadChaptersMetadata(grade, track);
// âœ… Ø­Ø°Ù Ø´Ø¯: await _loadLessonsMetadata(grade, track);
await _loadVideosMetadata(grade, track);
```

**Ù‡Ù…ÛŒÙ† ØªØºÛŒÛŒØ± Ø¨Ø§ÛŒØ¯ Ø¯Ø± Ø®Ø· 267 Ù‡Ù… Ø§Ø¹Ù…Ø§Ù„ Ø´ÙˆØ¯**

---

## ğŸ“‹ Ú†Ú©â€ŒÙ„ÛŒØ³Øª Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¬Ø±Ø§

- [x] Backup Ú©Ø§Ù…Ù„ Ø§Ø² Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ú¯Ø±ÙØªÙ‡ Ø´Ø¯Ù‡
- [x] ØªØµÙ…ÛŒÙ…â€ŒÚ¯ÛŒØ±ÛŒ Ø¯Ø± Ù…ÙˆØ±Ø¯ `prereq_lesson_id` (ÙÛŒÙ„Ø¯ Ù†Ú¯Ù‡ Ø¯Ø§Ø´ØªÙ‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ØŒ FK Ø­Ø°Ù Ù…ÛŒâ€ŒØ´ÙˆØ¯)
- [x] Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù‡ Ø¢ÛŒØ§ `getLessons` Ø¯Ø± Ø¬Ø§Ù‡Ø§ÛŒ Ø¯ÛŒÚ¯Ø± Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ (Ø¨Ø±Ø±Ø³ÛŒ Ø´Ø¯: ÙÙ‚Ø· Ø¯Ø± 3 Ø¬Ø§)
- [ ] ØªØ³Øª Migration Ø¯Ø± Ù…Ø­ÛŒØ· ØªØ³Øª
- [ ] ØªØ³Øª Edge Functions Ø¨Ø¹Ø¯ Ø§Ø² deploy
- [ ] ØªØ³Øª Flutter app Ø¨Ø¹Ø¯ Ø§Ø² ØªØºÛŒÛŒØ±Ø§Øª

---

Ø§ÛŒÙ† ÙØ§ÛŒÙ„ Ø´Ø§Ù…Ù„ ØªÙ…Ø§Ù… Ú©Ø¯Ù‡Ø§ÛŒ Ú©Ø§Ù…Ù„ Ø§Ø³Øª Ú©Ù‡ Ø¯Ø± Ù¾Ù„Ù† Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.

---

## âœ… Ú¯Ø²Ø§Ø±Ø´ Ù†Ù‡Ø§ÛŒÛŒ Ø¨Ø±Ø±Ø³ÛŒ Ù¾Ù„Ù†

### ğŸ“Š Ø®Ù„Ø§ØµÙ‡ ÙˆØ¶Ø¹ÛŒØª:

**Ù†Ù‚Ø§Ø· Ù‚ÙˆØª:**
- âœ… Migration SQL Ú©Ø§Ù…Ù„ Ùˆ Ø§ØµÙˆÙ„ÛŒ Ø§Ø³Øª
- âœ… Ù‡Ù…Ù‡ Ù…Ø´Ú©Ù„Ø§Øª Ø¨Ø­Ø±Ø§Ù†ÛŒ Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ùˆ Ø­Ù„ Ø´Ø¯Ù‡â€ŒØ§Ù†Ø¯
- âœ… ØªØ±ØªÛŒØ¨ Ø§Ø¬Ø±Ø§ÛŒ Ù…Ø±Ø§Ø­Ù„ Ù…Ù†Ø·Ù‚ÛŒ Ø§Ø³Øª
- âœ… Ù‚ÙˆØ§Ù†ÛŒÙ† Ø§Ø¬Ø±Ø§ ÙˆØ§Ø¶Ø­ Ùˆ Ù…Ø´Ø®Øµ Ø§Ø³Øª
- âœ… Ú©Ø¯Ù‡Ø§ÛŒ Ú©Ø§Ù…Ù„ Ø¨Ø±Ø§ÛŒ Ù‡Ù…Ù‡ ØªØºÛŒÛŒØ±Ø§Øª Ø§Ø±Ø§Ø¦Ù‡ Ø´Ø¯Ù‡
- âœ… Ù…Ø´Ú©Ù„Ø§Øª Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡ Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ùˆ Ø±Ø§Ù‡â€ŒØ­Ù„ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù‡

**Ù¾ÙˆØ´Ø´ ØªØºÛŒÛŒØ±Ø§Øª:**
- âœ… Migration SQL (Ú¯Ø§Ù…â€ŒÙ‡Ø§ÛŒ 1-9)
- âœ… Edge Function create-content (Ú©Ø§Ù…Ù„)
- âœ… Edge Function update-content (ØªØºÛŒÛŒØ±Ø§Øª Ù…Ø´Ø®Øµ)
- âœ… Flutter Model lesson_video.dart (Ú©Ø§Ù…Ù„)
- âœ… Flutter Service cached_content_service.dart
- âœ… Flutter Service content_service.dart
- âœ… Flutter Service mini_request_service.dart
- âœ… Flutter UI chapter_screen.dart
- âœ… Flutter UI subject_screen.dart
- âœ… Flutter UI dev_settings_button.dart

**Ù…Ø´Ú©Ù„Ø§Øª Ø­Ù„ Ø´Ø¯Ù‡:**
- âœ… Constraint unique_lesson_video
- âœ… Foreign Key prereq_lesson_id
- âœ… onConflict Ø¯Ø± create-content
- âœ… Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² getLessons Ø¯Ø± 3 ÙØ§ÛŒÙ„

**Ù†Ú©Ø§Øª Ù…Ù‡Ù…:**
- âš ï¸ ÙÛŒÙ„Ø¯ `lessonId` Ø¨Ø§ÛŒØ¯ Ø§Ø² `LessonVideo` model Ø­Ø°Ù Ø´ÙˆØ¯ (Ø¯Ø± fromJson Ùˆ toJson Ù‡Ù…)
- âš ï¸ Ù…ØªØ¯ `getLessons` Ø¨Ø§ÛŒØ¯ Ø§Ø² `cached_content_service.dart` Ùˆ `content_service.dart` Ø­Ø°Ù Ø´ÙˆØ¯
- âš ï¸ Ù…Ø¯Ù„ `Lesson` Ù…Ù…Ú©Ù† Ø§Ø³Øª Ø¯Ø± Ø¬Ø§Ù‡Ø§ÛŒ Ø¯ÛŒÚ¯Ø± Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø´ÙˆØ¯ - Ø¨Ø±Ø±Ø³ÛŒ Ø´ÙˆØ¯

**ÙˆØ¶Ø¹ÛŒØª Ú©Ù„ÛŒ:** âœ… Ù¾Ù„Ù† Ú©Ø§Ù…Ù„ØŒ Ø¯Ù‚ÛŒÙ‚ Ùˆ Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø¬Ø±Ø§ Ø§Ø³Øª

---

## ğŸ“‹ ÛŒØ§Ø¯Ø¯Ø§Ø´Øª Ø¨Ø±Ø§ÛŒ Ø¨Ø¹Ø¯ Ø§Ø² Ø§Ø¬Ø±Ø§ÛŒ Ù…ÙˆÙÙ‚ Ù¾Ù„Ù†

### âš ï¸ Ù…Ù‡Ù…: Ø§ÛŒÙ† Ø¨Ø®Ø´ ÙÙ‚Ø· Ø¨Ø¹Ø¯ Ø§Ø² ØªØ§ÛŒÛŒØ¯ Ù…ÙˆÙÙ‚ÛŒØªâ€ŒØ¢Ù…ÛŒØ² Ø§Ø¬Ø±Ø§ÛŒ Ù¾Ù„Ù† Ø¨Ø§ÛŒØ¯ Ø§Ù†Ø¬Ø§Ù… Ø´ÙˆØ¯

**Ø¨Ø¹Ø¯ Ø§Ø² Ø§ÛŒÙ†Ú©Ù‡:**
1. âœ… Ù¾Ù„Ù† Ø¨Ù‡ Ø·ÙˆØ± Ú©Ø§Ù…Ù„ Ø§Ø¬Ø±Ø§ Ø´Ø¯
2. âœ… ØªØ³Øª Ø´Ø¯ Ùˆ Ù‡Ù…Ù‡ Ú†ÛŒØ² Ø¨Ø¯ÙˆÙ† Ù…Ø´Ú©Ù„ Ú©Ø§Ø± Ú©Ø±Ø¯
3. âœ… Ú©Ø§Ø±Ø¨Ø± ØªØ§ÛŒÛŒØ¯ Ú©Ø±Ø¯ Ú©Ù‡ Ù¾Ù„Ù† Ù…ÙˆÙÙ‚ÛŒØªâ€ŒØ¢Ù…ÛŒØ² Ø¨ÙˆØ¯Ù‡

**Ú¯Ø²Ø§Ø±Ø´ Ø¨Ø±Ø§ÛŒ Ù†Ø³Ø®Ù‡ Ù…Ø­ØµÙˆÙ„:**
- âœ… Ú¯Ø²Ø§Ø±Ø´ Ú©Ø§Ù…Ù„ Ø¯Ø± ÙØ§ÛŒÙ„ `PRODUCT_APP_MIGRATION_REPORT.md` Ø¢Ù…Ø§Ø¯Ù‡ Ø´Ø¯Ù‡ Ø§Ø³Øª
- Ø§ÛŒÙ† Ú¯Ø²Ø§Ø±Ø´ Ø´Ø§Ù…Ù„ ØªÙ…Ø§Ù… ØªØºÛŒÛŒØ±Ø§Øª Ø¨Ú©â€ŒØ§Ù†Ø¯ Ùˆ ØªØºÛŒÛŒØ±Ø§Øª Ù…ÙˆØ±Ø¯ Ù†ÛŒØ§Ø² Ø¯Ø± ÙØ±Ø§Ù†Øª Ù…Ø­ØµÙˆÙ„ Ø§Ø³Øª
- Ú¯Ø²Ø§Ø±Ø´ Ø´Ø§Ù…Ù„ ØªØºÛŒÛŒØ±Ø§Øª Ù…Ø¯Ù„â€ŒÙ‡Ø§ØŒ API CallsØŒ Ùˆ UI Ø§Ø³Øª
- Ú©Ø¯Ù‡Ø§ÛŒ Ú©Ø§Ù…Ù„ Ù‚Ø¨Ù„ Ùˆ Ø¨Ø¹Ø¯ Ø¯Ø± Ú¯Ø²Ø§Ø±Ø´ Ù…ÙˆØ¬ÙˆØ¯ Ø§Ø³Øª
- **Ù†Ú©ØªÙ‡ Ù…Ù‡Ù…:** Ø¯Ø± Ú¯Ø²Ø§Ø±Ø´ Ù‚ÛŒØ¯ Ø´Ø¯Ù‡ Ú©Ù‡ Mini-Request Ø¯Ø± Ù†Ø³Ø®Ù‡ Ù…Ø­ØµÙˆÙ„ Ø¨Ø§ÛŒØ¯ Ø­ÙØ¸ Ø´ÙˆØ¯ Ùˆ ÙÙ‚Ø· Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¯Ø§Ø±Ø¯ (Ù‡ÛŒÚ† Ø§Ø´Ø§Ø±Ù‡â€ŒØ§ÛŒ Ø¨Ù‡ Ø­Ø°Ù Mini-Request Ø¯Ø± Ù†Ø³Ø®Ù‡ Ø§Ø¯Ù…ÛŒÙ† Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª)

