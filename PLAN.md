## پلن توسعه و هم‌راستا کردن پنل ادمین با بک‌اند (بر اساس `ADMIN_PANEL_BACKEND_GUIDE_V2.md`)

این پلن **مستقیماً اجرا خواهد شد** بدون نیاز به تأیید مرحله‌ای. تمام تغییرات بر اساس ساختار واقعی تیبل‌ها (بررسی شده با MCP) اعمال می‌شود.

---

### ⚠️ هشدار مهم: ساختار واقعی تیبل‌ها (بررسی شده با MCP)

**این پلن بر اساس ساختار واقعی تیبل‌های دیتابیس (بررسی شده با ابزار MCP-Supabase) نوشته شده است.**  
**اختلاف‌های مهم بین گزارش `ADMIN_PANEL_BACKEND_GUIDE_V2.md` و ساختار واقعی:**

1. **`lesson_videos`:**
   - گزارش: `id`, `grade`, `subject_slug`, `chapter_order`, `lesson_order`, `teacher_name`, `style`, `aparat_url`, `embed_html`, `note_pdf_url`, `exercise_pdf_url`, `duration_sec`
   - **واقعیت:** `video_id`, `grade_id`, `book_id`, `chapter_id`, `step_number`, `title`, `type`, `teacher`, `direct_url`, `embed_url`, `pdf_url` (یک فیلد واحد), `duration`, `thumbnail_url`, `likes_count`, `views_count`
   - ⚠️ **توجه:** ساختار واقعی با گزارش متفاوت است؛ در این پلن از ساختار واقعی استفاده می‌شود.

2. **`book_answer_pdfs`:**
   - گزارش: `year` (INTEGER, NULLABLE)
   - **واقعیت:** `author` (TEXT, NOT NULL) - `year` وجود ندارد
   - ⚠️ **توجه:** در پلن از `author` استفاده می‌شود، نه `year`.

3. **`change_counts`:**
   - گزارش: `grade`, `track`, `change_count`, `last_updated`
   - **واقعیت:** `grade` (1-21), `change_count`, `last_updated` - `track` وجود ندارد
   - ⚠️ **توجه:** شمارنده فقط بر اساس `grade` است، نه `track`.

4. **`provincial_sample_pdfs`:**
   - ✅ ساختار واقعی با گزارش هماهنگ است (`type`, `year`, `author`, `has_answer`, `pdf_url` همه موجود هستند).

**نتیجه:** در تمام مراحل این پلن، از ساختار واقعی تیبل‌ها (بررسی شده با MCP) استفاده می‌شود و نه از ساختار توضیح‌داده‌شده در گزارش (که ممکن است قدیمی باشد).

---

---

### قوانین کلی که در تمام مراحل رعایت می‌شود

- **سادگی کد**: منطق‌ها و ساختارها تا حد ممکن ساده و قابل‌خواندن نوشته می‌شوند؛ از الگوهای پیچیده و انتزاع‌های اضافی خودداری می‌شود.
- **اجرای مستقیم پلن**: تمام تغییرات بدون نیاز به تأیید مرحله‌ای اعمال می‌شود.
- **حفظ یک پلن واحد**: هر اصلاح یا تغییر جدیدی که بعداً از من بخواهی، روی همین `plan.md` و همین پلن به‌روزرسانی می‌شود؛ فایل پلن دیگری ساخته نخواهد شد.
- **رعایت وابستگی‌ها**: هرجا فایلی یا روالی را تغییر بدهم، حواسم به همهٔ متدها، سرویس‌ها و صفحه‌های وابسته خواهد بود و آن‌ها هم مطابق پلن به‌روزرسانی می‌شوند.
- **رعایت معماری بک‌اند جدید**: همهٔ تغییرات باید با تیبل‌ها و قراردادهای توضیح‌داده‌شده در `ADMIN_PANEL_BACKEND_GUIDE_V2.md` هماهنگ باشند.
- **عدم استفاده از Mini-Request در پنل ادمین**: هر صفحهٔ ادمین فقط از ریکوئست‌های مستقیم Supabase (یا Edge Functions) استفاده می‌کند؛ هیچ وابستگی جدیدی به Mini-Request/Hive اضافه نمی‌شود.
- **الزام لاگ‌گذاری با `logger`**:
  - در هر سرویس و هر متد مهم:
    - روی شروع عملیات، ورودی‌های مهم و نتیجهٔ موفق از `logger.info` استفاده می‌شود.
    - روی خطاها، استثناءها و پاسخ‌های غیرمنتظره از `logger.error` استفاده می‌شود.
  - پیام‌های لاگ باید کوتاه، قابل‌فهم و شامل اطلاعات کلیدی (مثل نام متد، نوع عملیات، `id` محتوا) باشند و حاوی داده‌های حساس (مثل توکن) نباشند.

> نمونهٔ الگوی لاگ‌گذاری که در همهٔ سرویس‌ها سعی می‌کنم شبیه آن عمل کنم (این فقط مثال است و در مراحل بعدی، برای هر سرویس نسخهٔ اختصاصی خودش را می‌نویسم):

```dart
class ExampleService {
  Future<void> doSomething({required int contentId}) async {
    logger.info('ExampleService.doSomething started', {
      'contentId': contentId,
    });

    try {
      // ... call Supabase / Edge Function ...

      logger.info('ExampleService.doSomething succeeded', {
        'contentId': contentId,
      });
    } catch (error, stack) {
      logger.error(
        'ExampleService.doSomething failed',
        {
          'contentId': contentId,
          'error': error.toString(),
        },
        stackTrace: stack,
      );
      rethrow;
    }
  }
}
```

---

## مرحله ۱ – هم‌ترازی مفهوم‌ها و مدل‌ها با تیبل‌های جدید بک‌اند

تمام Modelها و سرویس‌های پنل ادمین با ساختار تیبل‌های جدید (`lesson_videos`, `book_answer_pdfs`, `provincial_sample_pdfs`, `banners`) هم‌راستا خواهند شد. هیچ وابستگی‌ای به تیبل‌ها/فیلدهای حذف‌شده (مثل `step_by_step_pdfs` قدیمی، `level`, `subject_id`) باقی نخواهد ماند.

### ۱.۱. مرور و مستندسازی وضعیت فعلی مدل‌ها و سرویس‌ها

تمام Modelهای فعلی برای محتوای داینامیک (ویدیو، PDF گام‌به‌گام، PDF نمونه سؤال استانی، بنرها) شناسایی و بررسی خواهند شد. هر مدل با تیبل و فیلدهای دیتابیس مربوطه مچ خواهد شد و وابستگی‌های قدیمی حذف خواهند شد.

### ۱.۲. تطبیق مدل ویدیوها با تیبل `lesson_videos`

مدل ویدیو (`LessonVideo` و `VideoUploadFormData`) با ساختار واقعی تیبل `lesson_videos` هم‌راستا خواهد شد:
- `grade` → `grade_id`
- `subject_slug` → `book_id`
- `chapter_order` → `chapter_id`
- `lesson_order` → `step_number`
- `teacher_name` → `teacher`
- `style` → `type`
- `aparat_url` → `direct_url`
- `embed_html` → `embed_url`
- `note_pdf_url`, `exercise_pdf_url` → `pdf_url`
- `duration_sec` → `duration`

فرم آپلود ویدیو با فیلدهای جدید هم‌راستا خواهد شد.

### ۱.۳. تطبیق مدل گام‌به‌گام با تیبل `book_answer_pdfs`

مدل گام‌به‌گام با ساختار واقعی تیبل `book_answer_pdfs` هم‌راستا خواهد شد. فیلدهای قدیمی مثل `level`, `subject_id`, `fileSizeMb`, `title`, `year`, `file_url` حذف و با فیلدهای جدید (`grade_id`, `book_id`, `pdf_title`, `author`, `size`, `pdf_url`) جایگزین خواهند شد.

### ۱.۴. تطبیق مدل نمونه سؤال استانی با تیبل `provincial_sample_pdfs`

مدل نمونه سؤال استانی با ساختار واقعی تیبل `provincial_sample_pdfs` هم‌راستا خواهد شد. فیلدهای قدیمی مثل `level`, `subject_id`, `designer`, `fileSizeMb` حذف و mapping نهایی فیلدها اعمال خواهد شد.

---

## مرحله ۲ – هم‌راستا کردن فرم‌ها و صفحه‌های ادمین با تیبل‌ها و JSONها

فرم‌های ایجاد/ویرایش در پنل ادمین با قرارداد بک‌اند و JSONهای ثابت هماهنگ خواهند شد. dropdownها و فیلترها از روی `grades.json` و فایل‌های `gradeX.json` ساخته خواهند شد.

### ۲.۱. فرم آپلود و ویرایش ویدیو (`lesson_videos`)

فرم آپلود ویدیو با ساختار واقعی `lesson_videos` هم‌راستا خواهد شد. ویدیوها مستقیماً از تیبل `lesson_videos` خوانده خواهند شد. آیکون و کاور از JSONهای پایه (`gradeX.json`) استخراج خواهند شد.

### ۲.۲. فرم‌های گام‌به‌گام (`book_answer_pdfs`)

فرم گام‌به‌گام با ساختار واقعی تیبل هم‌راستا خواهد شد. dropdownها بر اساس JSON ساخته خواهند شد. گام‌به‌گام‌ها مستقیماً از `book_answer_pdfs` خوانده خواهند شد.

### ۲.۳. فرم‌های نمونه سؤال استانی (`provincial_sample_pdfs`)

فرم نمونه سؤال استانی با ساختار واقعی تیبل هم‌راستا خواهد شد. enum برای `type` با گزینه‌های `first_term`, `second_term`, `midterm_1`, `midterm_2` تعریف خواهد شد. نمونه سؤال‌ها مستقیماً از `provincial_sample_pdfs` خوانده خواهند شد.

### ۲.۴. فرم مدیریت بنرها (`banners`)

صفحه مدیریت بنرها با ساختار پیشنهادی (`title`, `image_url`, `link_url`, `active`, `position`) هم‌راستا خواهد شد. بنرها مستقیماً از تیبل `banners` خوانده خواهند شد.

---

## مرحله ۳ – یکپارچه‌سازی لایهٔ سرویس و Edge Functionها با معماری جدید

تمام عملیات CRUD در پنل ادمین از مسیر درست انجام خواهد شد. تریگرهای `change_counts` به‌درستی فعال خواهند شد.

### ۳.۱. ویدیوها – استفاده از Edge Functionهای `create-content`, `update-content`, `delete-content`

سرویس‌های ویدیو با Edge Functionهای `create-content`, `update-content`, `delete-content` هم‌راستا خواهند شد. هر عملیات CRUD ویدیویی باعث افزایش `change_count` برای `grade` مربوطه خواهد شد.

### ۳.۲. گام‌به‌گام و نمونه سؤال – سرویس‌های CRUD مطابق تیبل‌های جدید

سرویس‌های PDF (گام‌به‌گام و نمونه سؤال) با `book_answer_pdfs` و `provincial_sample_pdfs` هم‌راستا خواهند شد. عملیات CRUD باعث افزایش `change_count` خواهند شد.

### ۳.۳. هماهنگی با `change_counts`

تمام عملیات CRUD (ویدیو، گام‌به‌گام، نمونه سؤال) باعث افزایش `change_count` برای `grade` مربوطه خواهند شد. تریگرهای دیتابیس تضمین خواهند کرد که شمارنده دقیقاً یک بار افزایش یابد.

---

## مرحله ۴ – هم‌ترازی UI/UX پنل ادمین با اپ اصلی و نیازهای محصول

نحوهٔ نمایش لیست‌ها، فیلترها و کارت‌ها در پنل ادمین با ساختار JSON و تیبل‌ها هماهنگ خواهد شد.

### ۴.۱. لیست ویدیوها – فیلترها و ستون‌ها

صفحه لیست ویدیوها با فیلترها و ستون‌های جدید (`grade_id`, `book_id`, `chapter_id`, `step_number`, `type`, `active`) هم‌راستا خواهد شد.

### ۴.۲. لیست گام‌به‌گام‌ها و نمونه سؤال‌ها

لیست‌های PDF با فیلترها و ستون‌های جدید هم‌راستا خواهند شد.

### ۴.۳. هماهنگی آیکن‌ها و اسلاگ‌ها با JSON

آیکون‌ها و نام‌های درس در پنل ادمین با JSONهای پایه هم‌راستا خواهند شد.

---

## مرحله ۵ – مرور نهایی، تست مرحله‌ای و پاک‌سازی کدهای قدیمی

هیچ وابستگی‌ای به تیبل‌ها و فیلدهای حذف‌شده باقی نخواهد ماند. کد پنل ادمین ساده و تمیز خواهد شد.

### ۵.۱. حذف کامل وابستگی به تیبل‌ها و فیلدهای قدیمی

تمام ارجاعات قدیمی (تیبل‌ها و فیلدهای قدیمی) حذف و با ساختار جدید جایگزین خواهند شد.

### ۵.۲. ساده‌سازی و تمیزکاری نهایی کد

کد ساده‌سازی و تمیزکاری خواهد شد. قوانین UI (راست‌به‌چپ، فونت ایران‌سن‌س، رنگ‌های تم) رعایت خواهند شد.


